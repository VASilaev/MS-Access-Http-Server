# MS Access HTTP Server

Набор утилит и скриптов, для поднятия HTTP сервера на базе БД Access. Пишите на привычном Visual Basic с использованием современных Web технологий.

Механизм следующий: Access запускает AutoHotKey. AutoHotKey через VBScript создает линк на Access. Так же AutoHotKey поднимает HTTP сервер по порту который передал Access.

Возможности:

 - Обработка статичный файлов.
 - Выполнение функций в Access по запросу.
 - Доступ к объектной модели Access.Application.
 - Поддержка технологии динамического создания страниц на стороне "сервера". ASP на минималках.


Порядок работы:
 - Запускаем Демо.accdb
 - Запускаем процедуру StartServer. Сервер запускается на порту 5678. можно поменять в модуле ServerProcessor
 - Для обзора краткой справки переходим в любой браузер и переходим по адресу [http://localhost:5678/static/hello.vb](http://localhost:5678/static/hello.vb)

## Структура файлов

 - **AutoHotkeyU32.exe** - Интерпретатор файлов AHK
 - **AccessServer.ahk** - Основной файл сценария настройки Web сервера
 - **mime.types** - Ассоциации расширений файлов с MIME
 - **\lib\ActiveScript.ahk** - Библиотека AHK позволяющая внедрять скрипты VBS и JS
 - **\lib\AHKsock.ahk** - Библиотека AHK для работы с сокетами, нужна для AHKhttp
 - **\lib\AHKhttp.ahk** - Библиотека HTTP сервера
 - **\static\404.html** - Заглушка для "Страница не найдена"
 - **\static\\*** - Файлы расположенные в этой папке будут доступны по адресу /static/*

## Настройка сервера

Порт по которому будет приниматься запросы задается в Модуле `ServerProcessor`, константа `nPort`

Остальные настройки производятся в файле `AccessServer.ahk`

Сервер может обрабатывать два вида запросов точный и по регулярному выражению. Сначала проверяется список точных соответствий, затем по регулярному выражению, если соответствий не найдено, то выдается страница /404.

Точные запросы собираются в переменную paths и затем передаются в объект сервера `server.SetPaths(paths)`

`Paths` представляет собой ассоциативный массив, где ключ представляет собой точный путь до обрабатываемого ресурса, а значение является массивом из двух значений. Первым элементом идет ссылка на функцию AHK - обработчик запроса на уровне AHK. Второй параметр (экстра параметр) передается как четвертый параметр в функцию обработчик.

Запросы по регулярному выражению собираются в переменную special и затем передаются в объект сервера `server.SetSpecial(special)`

`special` представляет собой ассоциативный массив, где ключ представляет собой регулярное выражение, используемое как шаблон пути до обрабатываемого ресурса, а значение является массивом из двух значений. Первым элементом идет ссылка на функцию AHK - обработчик запроса на уровне AHK. Второй параметр (экстра параметр) передается как четвертый параметр в функцию обработчик.

## Преднастроенные функции обработчики

### NotFound

Заглушка для "Страница не найдена". При наличии файла `/static/404.html`, выводит его. Если файла нет, то выводит фразу "Page not found"

### Resource

Передает файл с диска клиенту. При настройке экстра параметр должен содержать массив из двух элементов.

 - Первый элемент это базовый путь, который дописывается в начала запроса. Например базовый путь "с:\temp", запрошен был файл "/static/404.html", клиенту будет передан файл "с:\temp\static\404.html".
 - Второй элемент - это обработчик специальных расширений файлов, который представляет из себя ассоциативный массив, где в качестве ключа расширение файла (в нижнем регистр), а значение массив из 3-х элементов
    = Ссылка на функцию AHK - обработчик запроса на уровне AHK
    = Значение передаваемое как 4-й параметр обработчика
    = Ассоциативный массив дополнительных параметров, который копируется в req.queries

### ProcessRequest

Вызывает функцию в Access, а ее результат отдает клиенту. Имя Функции берется как последняя компонента пути запроса. Например для /access/qr должна быть функция с именем QR. Функция должна быть с единственным параметром типа Variant. Через данный параметр передается контекст выполнения.

```vb
Public Function QR(context)
  'Функция обрабатывает конечную точку /access/qr
  Dim svQuery
  'Параметры получаем следующим образом
  svQuery = context("sys$queries")(0)("s")
  
  'Здесь производим обработку. В идеале быстро куда то положили и забыли
  Debug.Print svQuery, context("sys$pathWithParam")
  CurrentDb.Execute "insert into tRequest (sQuery) values ('" & Replace(svQuery, "'", "''") & "')"
  
  'Нужно вернуть HTML страничку.
  QR = "OK"
  
  'По умолчанию все страничку возвращаются с ответом 200, если нужно изменить статус:
  'context("sys$status") = 500
  
  'Для передачи дополнительных заголовков использую следующий метод
  'context("sys$response")(0)("headers")("Content-type") = "text/html"
End Function
```

### ProcessVBFile

Возвращает содержимое динамической страницы. Сильно урезанная технология ASP.

Представляет собой обычный HTML файл в кодировке Win1251 (но клиенту файл уйдет в формате UTF-8, не забудьте указать кодировку в заголовке страницы). Файл может содержать скрипты.

Скрипт помеченный <% и %> выполняется сервером.

Для вывода текста из скрипта используйте функцию Write.

Пример вывода строки:

```vb
Write "Hello World"
```

Для доступа к объектной модель Access.Application связанной БД используйте глобальную переменную Access:

```vb
Write Access.CurrentProject.Path & "\" & Access.CurrentProject.Name
```

Можно выводить содержимое таблицы:

```vb
With Access.CurrentDb.OpenRecordset("select * from tRequest")
Do While Not .EOF
  Write "<tr><td>" & .Fields("id").Value & "</td><td>" & _
        .Fields("dCreateDateTime").Value & "</td><td>" & _
        .Fields("sQuery").Value & "</td></tr>"
  .MoveNext
Loop
.Close
End With  
```

Для сохранения переменных между блоками используйте CurrentContext, содержимое не сохраняется между отрисовками страниц.

```vb
CurrentContext("var") = 123
...
Write "Var = " & CurrentContext("var")
```

Для сохранения данных между отрисовками используйте GlobalContext:

```vb
GlobalContext("Counter") =  GlobalContext("Counter") + 1
Write "Счетчик запуска страницы = " & GlobalContext("Counter")
```

В движке используются так же еще переменные: `ObjJava`, `ObjFSO`, `nDbgLevel`, `sPageContent`, `sCurrentPath`, `sLastFile`, `sBlockCode`. Изменение их содержимого может привести к не предсказуемым последствиям.

Для вывода строки содержащей спецсимволы HTML используйте функцию HTML.

```vb
Write html("Мне нужны эти <угловые скобки>", "", "")
```

Если вторым параметром передать имя тега, то каждая строка будет завернута в этот тег, иначе символы перевода строк заменяются на BR:

```vb
Write html("<Параграф 1>" & vbCr & "<Параграф 1>", "p", "")
```

Третьим параметром передается дополнительные атрибуты открывающего тега

```vb
Write html("<Блок 1>" & vbCr & "<Блок 1>", "span", " style=""background-color: #0090f0;""")
```

Функция Include интегрирует в текущий файл содержимое указанного. Для указания относительного пути начинайте имя с ".\". Относительный путь считается от текущего обрабатываемого файла.

```vb
Include ".\IncludeSample.inc"
```

Отладка только принтами. Для вывода в лог в файле AccessServer.ahk раскоменнтируйте запись в лог файл :

```ahk
;Ведение лога
WriteLog(text) {
 FileAppend, % A_NowUTC ": " text "`n", % A_ScriptDir "/logfile.txt"
}       
```

Затем можно использовать функцию dbg. Принимает два параметра Текст, Изменения уровня.

```vb
'Для вывода на текущем уровне
dbg "Var = [" & var & "]", 0

'Если нужно структурировать вывод 
dbg "Block Entry", +2
'Весь последующий вывод будет сдвинут на два пробела
...
dbg "Block List 1", 0
...
dbg "Block List 2", 0
...
'При выходе из блока нужно уменьшить число пробелов
dbg "Block Exit", -2
```